<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="/css/upload.css" />
    <title>Generate Page</title>
  </head>
  <body>
    <div id="container">
      <div id="background"></div>
      <div id="background-filter"></div>
      <div id="card">
        <div id="card-header">
          <h1 class="title">파일 업로드</h1>
        </div>
        <form
          id="card-body"
          action="/upload/generate"
          method="post"
          enctype="multipart/form-data"
          onsubmit="upload(event)"
        >
          <div id="file-area">
            <label for="audio-input">
              <div class="input-box">
                <h4 id="audio-label">변환할 오디오 파일을 선택해주세요.</h4>
              </div>
            </label>
            <label for="cover-input">
              <div class="input-box">
                <h4 id="cover-label">커버 이미지를 선택해 주세요.</h4>
              </div>
            </label>
          </div>
          <input id="audio-input" name="audio" type="file" accept=".wav" hidden />
          <input id="cover-input" name="cover" type="file" accept="image/*" hidden />
          <div class="text-area">
            <label>제목</label>
            <input id="text-input" name="title" type="text" />
          </div>
          <div class="text-area">
            <label>아티스트</label>
            <input id="text-input" name="sub_title" type="text" />
          </div>
          <button type="submit">오디오 변환 및 업로드</button>
        </form>
      </div>
    </div>
    <script>
      const LABEL_FIELDS = {
        audio: { label: "audio-label", text: "변환할 오디오 파일을 선택해주세요." },
        cover: { label: "cover-label", text: "커버 이미지를 선택해 주세요." },
      };

      const form = document.querySelector("form");
      const title = document.querySelector("input[name='title']");

      const onChange = (e) => {
        const file = e.target.files[0];
        const name = e.target.name;
        const label = document.getElementById(LABEL_FIELDS[name].label);

        if (file) {
          label.innerText = file.name;
          if (file.type == "audio/wav") {
            title.value = file.name.replace(".wav", "");
          }
        } else {
          label.innerText = LABEL_FIELDS[name].text;
        }
      };

      const setLoading = (isLoading) => {
        if (isLoading) {
          audioInput.setAttribute("disabled", true);
          coverInput.setAttribute("disabled", true);
        } else {
          audioInput.removeAttribute("disabled");
          coverInput.removeAttribute("disabled");
        }
      };

      const upload = async (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        if (audioInput.value != "" || coverInput.value != "") {
          setLoading(true);

          await fetch("/upload/generate", {
            method: "POST",
            body: formData,
          })
            .then((res) => {
              const status = res.status;
              alert("변환 및 업로드가 완료되었습니다.");
            })
            .catch((error) => {
              alert(error.message);
            });

          setLoading(false);
        } else {
          alert("업로드할 파일을 선택해 주세요.");
        }
      };

      const audioInput = document.getElementById("audio-input");
      const coverInput = document.getElementById("cover-input");
      audioInput.addEventListener("change", onChange);
      coverInput.addEventListener("change", onChange);
    </script>
  </body>
</html>
